<!-- 
	Replace any Job or Jobs with Capitalized name of your resources e.g. Application or Applications
	Replace any job or jobs with lower case name of your resources e.g. application or applications
 -->

<div id="contentClusteredScheduler">
	<div class="modal" id="addClusteredSchedulerForm" tabindex="-1" role="dialog" dialog-for="contentClusteredScheduler">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group">
						<label class="col-xs-3 control-label" localize="job.name.label"></label>
						<div class="propertyValue col-xs-9">
							<input type="text" class="form-control"
								 id="resourceName" maxlength="" name="resourceName" value="">
							<div>
								<span class="help-block" localize="job.name.info"></span>
							</div>
						</div>
					</div>
					
					<div id="clusteredSchedulerProperties"></div>
					<input type="hidden" id="resourceId" name="resourceId" value="" />
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>

</div>

<script type="text/javascript">

function statusFormatter(value, row, index) {
	var t  = '';
	t += '<div';
	if(value == 'COMPLETE_WITH_ERRORS') {
		t += ' class="alert-danger"';
	}
	t += '>';
	t += getResource('job.' + value);
	t += '</div>';
	if(value == 'COMPLETE_WITH_ERRORS') {
		t += '<br/><small>' + row.error + '</small>';
	}
	return t;
}

function jobDateFormatter(value, row, index) {
	if(!value) {
		return getResource("job.never.text");
	}
	var today = new Date();
	var yesterday = (function(d){ d.setDate(d.getDate()-1); return d})(new Date);
	var fileDate = new Date(value);
	var todayStr = today.format('yyyy-mm-dd');
	var yesterdayStr = yesterday.format('yyyy-mm-dd');
	var fileStr = fileDate.format('yyyy-mm-dd');
	if(todayStr === fileStr) {
		return getResource("job.today.text") + " " + fileDate.format("HH:MM");	
	} else if(yesterdayStr === fileStr) {
		return getResource("job.yesterday.text") + " " + fileDate.format("HH:MM");
	} else {
		return fileDate.format("d mmmm yyyy HH:MM");	
	}
}

	$(document).ready(function() {
				$('#contentClusteredScheduler').localize();
				
				$('#clusteredSchedulerProperties').propertyPage({
					url : 'clusteredScheduler/template',
					showButtons : false,
					useTemplates : true,
					canUpdate : currentMenu.canUpdate
				});

				$('#contentClusteredScheduler').ajaxResourcePage(
						{
							id : "ClusteredScheduler",
							tableUrl : "clusteredScheduler/table",
							title: getResource("jobs.label"),
							icon: 'fa-cog',
							resourceUrl : "clusteredScheduler/job",
							fields : [ {
								name : "name",
								sortable: true
							},{
								name : "description",
								sortable: false
							},{
								name : "status",
								sortable: true,
								formatter: statusFormatter
							}, {
								name: 'nextFire',
								sortable: true,
								formatter: jobDateFormatter
							}, {
								name: 'lastFire',
								sortable: true,
								formatter: jobDateFormatter
							}],
							forceActionsDropdown: true,
							additionalActions: [{
								resourceKey : 'fireJob',
								iconClass : 'fa-play',
								action : function(resource, callback) {
									getJSON('clusteredScheduler/fire/' + resource.id, null, function(data) {
										if(data.success) {
											showSuccess(getResource('text.jobTriggered').format(resource.name));
										} else {
											showError(data.message);
										}
										callback();
									});
								},
								enabled : true
							},{
								resourceKey : 'interruptJob',
								iconClass : 'fa-hand-paper-o ',
								action : function(resource, callback) {
									getJSON('clusteredScheduler/interrupt/' + resource.id, null, function(data) {
										if(data.success) {
											showSuccess(getResource('text.jobInterrupted').format(resource.name));
										} else {
											showError(data.message);
										}
										callback();
									});
								},
								enabled : true
							}],
							disableDecoration: true,
							resourceKey : "job",
							canCreate: false,
							canUpdate: false,
							canDelete: true,
							validate : function() {

								if ($('#resourceName').val() == '') {
									showError("error.nameRequired");
									return false;
								}

								if(!$('#clusteredSchedulerProperties').validateProperties()) {
									showError("error.correctValidationErrors");
									return false;
								}
								
								return true;
							},
							clearDialog : function(create) {
								
								$('#resourceId').val('');
								$('#resourceName').val('');
								
								$('#clusteredSchedulerProperties').clearProperties();
								if(create) {
									$('#clusteredSchedulerProperties').propertyPage({ 
										url : 'clusteredScheduler/template/', 
										showButtons : false, 
										canUpdate : currentMenu.canUpdate, 
										useTemplates : true 
									});
								}

								$('.tabPropertiesTab').first().trigger('click');
							},
							createResource : function() {
								resource = new Object();
								resource.id = $('#resourceId').val();
								resource.name = $('#resourceName').val();
								
								$('#clusteredSchedulerProperties').saveProperties(true,
										function(items) {
											resource.properties = items;
								});
								
								return resource;
							},
							displayResource : function(resource, readOnly) {
								
								$('#resourceId').val(resource.id);
								$('#resourceName').val(resource.name);
								
								$('#clusteredSchedulerProperties').propertyPage(
										{ url : 'clusteredScheduler/properties/' + resource.id, 
											showButtons : false, 
											canUpdate : currentMenu.canUpdate && !readOnly
								});
							
							},
							complete : function() {
								loadComplete();
							}
						});

			});
</script>