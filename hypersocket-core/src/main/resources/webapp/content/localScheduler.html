
<div id="contentLocalScheduler">
	<div class="modal" id="addLocalSchedulerForm" tabindex="-1" role="dialog" dialog-for="contentLocalScheduler">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header lb-modal-header-text-reverse">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group lb-row">
						<label class="col-3 control-label" localize="job.name.label"></label>
						<div class="propertyValue col-9">
							<input type="text" class="form-control"
								 id="resourceName" maxlength="" name="resourceName" value="">
							<div>
								<span class="lb-help-block form-text text-muted mt-2 mb-3 pl-1" localize="job.name.info"></span>
							</div>
						</div>
					</div>
					
					<div id="localSchedulerProperties"></div>
					<input type="hidden" id="resourceId" name="resourceId" value="" />
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
<div id="additionalActions"></div>
</div>

<script type="text/javascript">

function statusFormatter(value, row, index) {
	var t  = '';
	t += '<div';
	if(value == 'COMPLETE_WITH_ERRORS') {
		t += ' class="alert alert-danger"';
	}
	t += '>';
	t += getResource('job.' + value);
	t += '</div>';
	if(value == 'COMPLETE_WITH_ERRORS') {
		t += '<br/><small>' + row.error + '</small>';
	}
	return t;
}

function jobDateFormatter(value, row, index) {
	if(!value) {
		return getResource("job.never.text");
	}
	var today = new Date();
	var yesterday = (function(d){ d.setDate(d.getDate()-1); return d})(new Date);
	var fileDate = new Date(value);
	var todayStr = today.format('yyyy-mm-dd');
	var yesterdayStr = yesterday.format('yyyy-mm-dd');
	var fileStr = fileDate.format('yyyy-mm-dd');
	if(todayStr === fileStr) {
		return getResource("job.today.text") + " " + fileDate.format("HH:MM");	
	} else if(yesterdayStr === fileStr) {
		return getResource("job.yesterday.text") + " " + fileDate.format("HH:MM");
	} else {
		return fileDate.format("d mmmm yyyy HH:MM");	
	}
}

	legacyjQueryReadyFix(function() {
				$('#contentLocalScheduler').localize();
				
				$('#localSchedulerProperties').propertyPage({
					url : 'scheduler/template',
					showButtons : false,
					useTemplates : true,
					canUpdate : currentMenu.canUpdate
				});
				
				$('#contentLocalScheduler').ajaxResourcePage(
						{
							id : "LocalScheduler",
							tableUrl : "scheduler/table",
							title: getResource("jobs.label"),
							icon: 'fa-cog',
							resourceUrl : "scheduler/job",
							fields : [ {
								name : "name",
								sortable: true
							},{
								name : "description",
								sortable: true
							},{
								name : "realm",
								sortable: true
							},{
								name : "timeTaken",
								sortable: true,
								formatter: function(val, row, index) {
									return val == 0 ? '' : msToTime(val, true);
								}
							}, {
								name : "status",
								sortable: true,
								formatter: statusFormatter
							},{
								name: 'nextFire',
								sortable: true,
								formatter: jobDateFormatter
							}, {
								name: 'lastFire',
								sortable: true,
								formatter: jobDateFormatter
							}],
							additionalActions: [{
								resourceKey : 'fireJob',
								iconClass : 'fa-play',
								action : function(resource, callback) {
									getJSON('scheduler/fire/' + resource.id, null, function(data) {
										if(data.success) {
											showSuccess(getResource('text.jobTriggered').format(resource.name));
										} else {
											showError(data.message);
										}
										callback();
									});
								},
								enabled : true
							},{
								resourceKey : 'interruptJob',
								iconClass : 'fa-hand-paper',
								action : function(resource, callback) {
									getJSON('clusteredScheduler/interrupt/' + resource.id, null, function(data) {
										if(data.success) {
											showSuccess(getResource('text.jobInterrupted').format(resource.name));
										} else {
											showError(data.message);
										}
										callback();
									});
								},
								enabled : true
							}],
							disableDecoration: true,
							resourceKey : "job",
							canCreate: false,
							canUpdate: false,
							canDelete: true,
							validate : function() {

								if ($('#resourceName').val() == '') {
									showError("error.nameRequired");
									return false;
								}

								if(!$('#localSchedulerProperties').validateProperties()) {
									showError("error.correctValidationErrors");
									return false;
								}
								
								return true;
							},
							clearDialog : function(create) {
								
								$('#resourceId').val('');
								$('#resourceName').val('');
								
								$('#localSchedulerProperties').clearProperties();
								if(create) {
									$('#localSchedulerProperties').propertyPage({ 
										url : 'scheduler/template/', 
										showButtons : false, 
										canUpdate : currentMenu.canUpdate, 
										useTemplates : true 
									});
								}

								$('.tabPropertiesTab').first().trigger('click');
							},
							createResource : function() {
								resource = new Object();
								resource.id = $('#resourceId').val();
								resource.name = $('#resourceName').val();
								
								$('#localSchedulerProperties').saveProperties(true,
										function(items) {
											resource.properties = items;
								});
								
								return resource;
							},
							displayResource : function(resource, readOnly) {
								
								$('#resourceId').val(resource.id);
								$('#resourceName').val(resource.name);
								
								$('#localSchedulerProperties').propertyPage(
										{ url : 'scheduler/properties/' + resource.id, 
											showButtons : false, 
											canUpdate : currentMenu.canUpdate && !readOnly
								});
							
							},
							complete : function() {
								loadComplete();
							}
						});

			});
</script>